<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>CHINACNU é’¢å·æŠ¥ä»·ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; max-width: 800px; margin: auto; }
    h1 { text-align: center; color: #1a73e8; }
    label { display: block; margin-top: 16px; font-weight: bold; }
    select, input, button {
      width: 100%; padding: 10px; margin-top: 6px; font-size: 16px;
    }
    .result { margin-top: 30px; background: #fff; padding: 20px; border: 1px solid #ccc; }
    .hidden { display: none; }
  </style>
</head>
<body>

<h1>CHINACNU é’¢å·æŠ¥ä»·ç³»ç»Ÿ</h1>

<label>äº§å“ç§ç±»</label>
<select id="product" onchange="updateFields()">
  <option value="å½©æ¶‚æ¿(æ–°å¢)">å½©æ¶‚æ¿(æ–°å¢)</option>
  <option value="æœ‰èŠ±é•€é”Œ åšæ¿">æœ‰èŠ±é•€é”Œ åšæ¿</option>
  <option value="æœ‰èŠ±é•€é”Œ (è–„æ¿)å¸¦ç²¾åŒ…">æœ‰èŠ±é•€é”Œ (è–„æ¿)å¸¦ç²¾åŒ…</option>
  <option value="é•€é“é”Œæ— è€æŒ‡çº¹">é•€é“é”Œæ— è€æŒ‡çº¹</option>
</select>

<label>åšåº¦ (mm)</label>
<input type="number" id="thickness" step="0.01" placeholder="ä¾‹å¦‚ï¼š0.35">

<div id="zincWrapper">
  <label>é”Œå±‚å±‚æ•°</label>
  <input type="number" id="zincCount" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š1">
</div>

<div id="coatingWrapper" class="hidden">
  <label>æ¼†è†œå±‚æ•°</label>
  <input type="number" id="coatingCount" min="0" step="1" placeholder="ä¾‹å¦‚ï¼š2">
</div>

<div id="fingerprintWrapper" class="hidden">
  <label>è€æŒ‡çº¹ç±»å‹</label>
  <select id="fingerprint">
    <option value="none">æ— </option>
    <option value="clear">é€æ˜åŒé¢</option>
    <option value="color">å½©è‰²åŒé¢</option>
    <option value="gold">é‡‘è‰²åŒé¢</option>
    <option value="green">ç»¿è‰²å•é¢</option>
  </select>
</div>

<label>å½“å‰æ±‡ç‡ (USDå…‘CNY)</label>
<input type="number" id="rate" step="0.01" value="7.20">

<button onclick="calculate()">è·å–æŠ¥ä»·</button>

<div class="result" id="result"></div>

<script>
  function updateFields() {
    const type = document.getElementById("product").value;
    document.getElementById("coatingWrapper").classList.add("hidden");
    document.getElementById("fingerprintWrapper").classList.add("hidden");
    if (type === "å½©æ¶‚æ¿(æ–°å¢)") {
      document.getElementById("coatingWrapper").classList.remove("hidden");
    }
    if (type === "é•€é“é”Œæ— è€æŒ‡çº¹") {
      document.getElementById("fingerprintWrapper").classList.remove("hidden");
    }
  }

  async function calculate() {
    const product = document.getElementById("product").value;
    const thickness = parseFloat(document.getElementById("thickness").value);
    const zincCount = parseInt(document.getElementById("zincCount").value) || 0;
    const coatingCount = parseInt(document.getElementById("coatingCount")?.value) || 0;
    const fingerprint = document.getElementById("fingerprint")?.value || "none";
    const rate = parseFloat(document.getElementById("rate").value);

    if (!thickness) {
      document.getElementById("result").innerHTML = "â— è¯·å¡«å†™åšåº¦";
      return;
    }

    const sheetId = "1L8RGRPI7BdIlDew99K7QIXU5f7llOLqWqskwXb1lms4";
    const range = "A1:Z100";
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/'${encodeURIComponent(product)}'!${range}?key=AIzaSyB-io6C9S0y5I6YXMi9TrDbAx8PkC2ReKo`;

    try {
      const res = await fetch(url);
      const data = await res.json();
      const headers = data.values[0];
      const rows = data.values.slice(1);
      const thicknessCol = headers.findIndex(h => h.includes("åšåº¦"));
      const priceCol = headers.findIndex(h =>
        h.includes("1000RMB") || h.includes("å®½åº¦(MM) 1000RMB")
      );

      let closestRow = null;
      let minDiff = Infinity;
      for (const row of rows) {
        const t = parseFloat(row[thicknessCol]);
        if (!isNaN(t)) {
          const diff = Math.abs(t - thickness);
          if (diff < 0.01 && diff < minDiff) {
            minDiff = diff;
            closestRow = row;
          }
        }
      }

      if (!closestRow) {
        document.getElementById("result").innerHTML = `æœªæ‰¾åˆ°åšåº¦ ${thickness} çš„æŠ¥ä»·ã€‚`;
        return;
      }

      const basePrice = parseFloat(closestRow[priceCol]);

      const density = 7850;
      const volumePerTon = 1 / (density / 1000);
      const areaPerTon = volumePerTon / (thickness / 1000);

      const zincCost = areaPerTon * zincCount * 0.025;
      const coatingCost = product === "å½©æ¶‚æ¿(æ–°å¢)" ? areaPerTon * coatingCount * 0.05 : 0;
      let fingerprintCost = 0;
      if (product === "é•€é“é”Œæ— è€æŒ‡çº¹") {
        if (fingerprint === "clear") fingerprintCost = areaPerTon * 0.23;
        if (fingerprint === "color") fingerprintCost = areaPerTon * 0.33;
        if (fingerprint === "gold") fingerprintCost = areaPerTon * 0.41;
        if (fingerprint === "green") fingerprintCost = areaPerTon * 0.23;
      }

      const totalAdd = zincCost + coatingCost + fingerprintCost;
      const totalPrice = basePrice + totalAdd;
      const totalUSD = totalPrice / rate;

      document.getElementById("result").innerHTML = `
        âœ… åŸä»·ï¼ˆæ¯å¨ï¼‰: Â¥${basePrice.toFixed(2)}<br>
        ğŸ§ª é”Œå±‚åŠ ä»·: Â¥${zincCost.toFixed(2)}<br>
        ğŸ¨ æ¼†è†œåŠ ä»·: Â¥${coatingCost.toFixed(2)}<br>
        ğŸ›¡ï¸ è€æŒ‡çº¹åŠ ä»·: Â¥${fingerprintCost.toFixed(2)}<br>
        <hr>
        ğŸ§¾ æœ€ç»ˆå«åŠ ä»·å•ä»·: <strong style="color:green">Â¥${totalPrice.toFixed(2)}</strong> / å¨<br>
        ğŸ’² æŠ˜åˆç¾å…ƒ: <strong style="color:blue">$${totalUSD.toFixed(2)}</strong>ï¼ˆæ±‡ç‡ Â¥${rate.toFixed(2)}ï¼‰
      `;
    } catch (err) {
      document.getElementById("result").innerHTML = "âŒ è·å–åŸä»·å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
      console.error(err);
    }
  }

  updateFields();
</script>

</body>
</html>
